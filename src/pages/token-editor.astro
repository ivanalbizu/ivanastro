---
import Layout from "@layouts/Layout.astro"
import PageHeader from "@components/PageHeader.astro";
import Button from "@components/Button.astro";

const pageTitle = "Editor de Design Tokens";
const pageDescription =
  "Personaliza los colores de tu sistema de dise√±o y navega por tu web mientras editas.";
---

<Layout
  title={`${pageTitle}`}
  description={pageDescription}
  showSidebar={false}
>
  <div class="container">
    <PageHeader title={pageTitle}>{pageDescription}</PageHeader>
    
    <div class="editor-controls">
      <Button tag="button" id="pip-btn">
        üñºÔ∏è Abrir en Picture-in-Picture
      </Button>
      <Button tag="button" id="download-yaml-btn" variant="secondary">
        üì• Descargar YAML
      </Button>
      <Button tag="button" id="reset-btn" variant="secondary">
        üîÑ Restaurar valores originales
      </Button>
    </div>

    <div class="info-box">
      <p><strong>üí° Tip:</strong> Usa Picture-in-Picture para mantener el editor visible mientras navegas por otras p√°ginas de tu sitio y ves los cambios en tiempo real.</p>
    </div>
  </div>

  <div class="editor-page">
    <h2 class="editor-title">Editor de Tokens</h2>
    <p class="editor-subtitle">Los cambios se aplican autom√°ticamente y persisten en todas las p√°ginas</p>
    
    <div id="token-editor-container"></div>
  </div>

  <!-- js-yaml solo en esta p√°gina -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

  <script>
    // @ts-nocheck - Deshabilitar verificaci√≥n de tipos en este script inline
    import { TokenEditor } from '../assets/js/token-system.js';

    let editor: any = null;

    function initEditor(): void {
      // Si ya existe un editor, no crear otro
      if (editor) {
        console.log('‚úÖ Editor already initialized');
        return;
      }

      // Esperar a que jsyaml est√© disponible
      if (typeof jsyaml === 'undefined') {
        console.log('‚è≥ Waiting for js-yaml to load...');
        setTimeout(initEditor, 100);
        return;
      }

      try {
        editor = new TokenEditor(
          '#token-editor-container',
          '#download-yaml-btn',
          '#reset-btn',
          '#pip-btn'
        );
        
        // Exponer el editor globalmente para que pueda ser recargado
        window.__tokenEditor = () => editor;
        
        console.log('‚úÖ Token Editor initialized successfully');
      } catch (error: any) {
        console.error('‚ùå Error initializing Token Editor:', error);
        
        // Mostrar error en la UI
        const container = document.querySelector('#token-editor-container');
        if (container) {
          container.innerHTML = `
            <div class="error-message">
              <h3>‚ùå Error al cargar el editor</h3>
              <p>${error?.message || 'Unknown error'}</p>
              <p>Aseg√∫rate de que el archivo <code>/tokens/colors.yaml</code> existe en <code>public/tokens/colors.yaml</code>.</p>
            </div>
          `;
        }
      }
    }

    function handlePageLoad(): void {
      const isEditorPage = window.location.pathname.includes('token-editor');
      
      if (isEditorPage) {
        console.log('üìÑ Token Editor page detected');
        // Peque√±o delay para asegurar que el DOM est√° completamente listo
        setTimeout(initEditor, 50);
      } else {
        // Limpiar editor si cambiamos de p√°gina
        editor = null;
        window.__tokenEditor = undefined;
        console.log('üìÑ Left Token Editor page');
      }
    }

    // Escuchar evento de tokens limpiados para recargar el editor
    window.addEventListener('tokens-cleared', async () => {
      if (editor && typeof editor.loadTokens === 'function') {
        console.log('üîÑ Tokens cleared event received, reloading editor...');
        await editor.loadTokens();
      }
    });

    // Escuchar eventos de View Transitions
    document.addEventListener('astro:page-load', handlePageLoad);
    
    document.addEventListener('astro:after-swap', () => {
      editor = null; // Reset editor
      window.__tokenEditor = undefined;
      handlePageLoad();
    });

    // Carga directa (sin View Transitions)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', handlePageLoad);
    } else {
      handlePageLoad();
    }
  </script>
</Layout>

<style>
  .container {
    max-width: 1400px;
    margin: 0 auto 2rem;
  }

  .editor-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
    justify-content: center;
  }

  .info-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.25rem;
    border-radius: 0.75rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .info-box p {
    margin: 0;
    font-size: 0.95rem;
    line-height: 1.6;
  }

  .info-box strong {
    font-weight: 700;
  }

  .editor-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    background: var(--color-theme-background-surface, #f8f9fa);
    min-height: 50vh;
    border-radius: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .editor-title {
    text-align: center;
    margin-bottom: 0.5rem;
    color: var(--color-theme-text-primary, #1e293b);
    font-size: 2rem;
  }

  .editor-subtitle {
    text-align: center;
    margin-bottom: 2rem;
    color: var(--color-theme-text-secondary, #64748b);
    font-size: 1rem;
  }

  .error-message {
    background: #fee;
    border: 2px solid #fecaca;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
  }

  .error-message h3 {
    color: #dc2626;
    margin-top: 0;
  }

  .error-message code {
    background: #fff;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'Consolas', 'Monaco', monospace;
  }

  /* === ESTILOS DEL EDITOR - DISE√ëO COMPACTO === */
  
  :global(.token-section) {
    margin-bottom: 2.5rem;
    background: var(--color-theme-background-default, white);
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  :global(.token-section__title) {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--color-theme-text-primary, #1e293b);
    border-bottom: 2px solid var(--color-theme-border-light, #e2e8f0);
    padding-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  :global(.token-section__title::before) {
    content: 'üé®';
    font-size: 1.1rem;
  }

  :global(.token-group) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.75rem;
  }

  /* CARD COMPACTA */
  :global(.token-card) {
    background: var(--color-theme-background-default, #ffffff);
    border: 1px solid var(--color-theme-border-light, #e2e8f0);
    border-radius: 0.5rem;
    padding: 0.75rem;
    transition: box-shadow 0.2s;
  }

  :global(.token-card:hover) {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  :global(.token-card__header) {
    margin-bottom: 0.6rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-theme-border-light, #f1f5f9);
  }

  :global(.token-card__path) {
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.7rem;
    color: var(--color-theme-text-secondary, #64748b);
    display: block;
    word-break: break-word;
    line-height: 1.3;
  }

  :global(.token-card__body) {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  /* CONTROLES COMPACTOS */
  :global(.token-card__control) {
    display: grid;
    grid-template-columns: auto 45px;
    gap: 0.5rem;
    align-items: center;
  }

  :global(.token-card__label-group) {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-theme-text-muted, #475569);
    display: flex;
    align-items: center;
    gap: 0.25rem;
    letter-spacing: 0.025em;
  }

  :global(.token-card__ref-swatch) {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    border: 1px solid var(--color-theme-border-default, #cbd5e1);
    flex-shrink: 0;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  /* REFERENCIAS */
  :global(.token-card__reference) {
    padding: 0.5rem;
    background: var(--color-theme-background-surface, #f8fafc);
    border-radius: 0.375rem;
    border: 1px solid var(--color-theme-border-light, #e2e8f0);
    grid-column: 1 / -1;
  }

  :global(.token-card__ref-path) {
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.7rem;
    color: var(--color-theme-text-secondary, #64748b);
    display: block;
    word-break: break-word;
    line-height: 1.3;
  }

  /* INPUT DE COLOR */
  :global(input[type="color"]) {
    width: 45px;
    height: 45px;
    border: 2px solid var(--color-theme-border-light, #e2e8f0);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.15s;
    padding: 0;
  }

  :global(input[type="color"]:hover) {
    border-color: var(--color-theme-border-default, #94a3b8);
  }

  :global(input[type="color"]:focus) {
    outline: none;
    border-color: var(--color-brand-interactive, #3b82f6);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }

  :global(input[type="color"]:focus-visible) {
    outline: 2px solid var(--color-brand-interactive, #3b82f6);
    outline-offset: 2px;
  }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .editor-page {
      padding: 1rem;
    }

    :global(.token-group) {
      grid-template-columns: 1fr;
    }

    .editor-title {
      font-size: 1.5rem;
    }

    .editor-controls {
      flex-direction: column;
    }
  }

  /* DARK MODE */
  @media (prefers-color-scheme: dark) {
    .editor-page {
      background: var(--color-theme-background-surface, #1a1a1a);
    }
  }
</style>