---
import Layout from "@layouts/Layout.astro";
import PageHeader from "@components/PageHeader.astro";
import PostMeta from "@components/PostMeta.astro";
import { Picture } from 'astro:assets';
import Pagination from "@components/Pagination.astro";
import { config } from "../../../config";

import type { GetStaticPaths, Page } from "astro";
import { getCollection } from "astro:content";

interface Props {
  page: Page<any>;
}

const base = import.meta.env.BASE_URL;

export const getStaticPaths: GetStaticPaths = (async ({ paginate }: any) => {
  const posts = await getCollection("blog");

  const allCategories = new Set<string>();
  posts.forEach((post: any) => {
    if (post.data.categories) {
      post.data.categories.forEach((category: string) => {
        allCategories.add(category);
      });
    }
  });

  return Array.from(allCategories).flatMap((category: string) => {
    const categorySlug = category.toLowerCase().replace(/[\/\s]+/g, "-");
    const postsInCategory = posts
      .filter(
        (post: any) =>
          post.data.categories &&
          post.data.categories.includes(category),
      )
      .sort(
        (a: any, b: any) =>
          new Date(b.data.date).getTime() -
          new Date(a.data.date).getTime(),
      );

    return paginate(postsInCategory,{
      params: { categoria: categorySlug },
      props: {
        categoria: category,
        posts: postsInCategory,
      },
      pageSize: config.pageSize
    });
  });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const { categoria } = Astro.params;
---

<Layout
  title={`${page.currentPage > 1 ? 'Página ' + page.currentPage : categoria}`}
  description={`Entrada{posts.length === 1 ? "" : "s"} en la categoría ${categoria}`}
>
  <div>
    <PageHeader title={`${categoria}`}>
      {page.total} entrada{page.total === 1 ? "" : "s"} en esta categoría
    </PageHeader>

    {
      page.data.length > 0 ? (
        <div class="posts-list">
          {page.data.map(async (post: any) => (
            <article class="post-item">
              <h2 class="post-title" transition:name={`transition-title-${post.id}`}>
                <a
                  href={`${base}blog/${post.id}`}
                >
                  {post.data.title}
                </a>
              </h2>
              {post.data.image && <Picture src={post.data.image} formats={['avif', 'webp']} alt="A description of my image." transition:name={`transition-picture-${post.id}`} />}
              <PostMeta frontmatter={post.data} showReadMore />
            </article>
          ))}
          {
            (page.lastPage > 1) && (
              <div>
                <Pagination
                  urlPattern={`/categorias/${categoria}`}
                  length={page.lastPage}
                  currentUrl={page.url.current}
                  currentPage={page.currentPage}
                  firstUrl={page.url.first}
                  prevUrl={page.url.prev}
                  nextUrl={page.url.next}
                  lastUrl={page.url.last}
                />
              </div>
            )
          }
        </div>
      ) : (
        <div class="no-posts">
          <p>
            No hay publicaciones en {" "}
            <code>src/pages/blog/</code>
          </p>
        </div>
      )
    }
  </div>
</Layout>

<style lang="scss">
  .posts-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
  }

  .post-item {
    border-bottom: var(--border-width-sm) solid var(--color-border);
    padding-bottom: var(--space-lg);
    &:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
  }

  .post-title {
    font-family: var(--typography-font-family-primary);
    font-size: var(--typography-font-size-heading-4);
    font-weight: var(--typography-font-weight-bold);
    margin-block-end: var(--space-sm);
    a {
      color: var(--color-text-primary);
      text-underline-offset: 3px;
      transition: color var(--transition-duration-normal) ease;
      &:hover,
      &:focus {
        color: var(--color-interaction-default);
      }
    }
  }

  .no-posts {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-muted);
    font-style: italic;
  }

  .no-posts code {
    background-color: var(--color-surface);
    padding: 2px 4px;
    border-radius: var(--border-radius-sm);
    font-family: var(--typography-font-family-mono);
  }
</style>
