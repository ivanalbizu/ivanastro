---
// TODO: evitar mostrar enlace del SinglePost actual 
import Button from "@components/Button.astro";

import { getCollection } from "astro:content";

const base = import.meta.env.BASE_URL;

export interface Props {
  limitRecentPost?: number;
}

const {
  limitRecentPost = 5,
} = Astro.props;

const posts = await getCollection("blog");
const recentPosts = posts
  .sort(
    (a: any, b: any) =>
      new Date(b.data.date).getTime() -
      new Date(a.data.date).getTime(),
  )
  .slice(0, limitRecentPost);

const categories = [
  ...new Set(
    posts.flatMap((post: any) => post.data.categories || []),
  ),
];
---

<div class="skip-to-content">
  <a href="#footer">Saltar los enlaces de sidebar</a>
</div>
<div class="sidebar-content">
  {
    recentPosts.length > 0 && (
      <section class="recent-posts">
        <h2 class="section-title" id="sidebar-recent">Entradas recientes</h2>
        <ul class="post-list" aria-labelledby="sidebar-recent">
          {recentPosts.map((post: any) => (
            <li class="post-item">
              <a
                href={`${base}blog/${post.data.slug}`}
                class="post-link"
              >
                {post.data.title}
              </a>
              <time class="post-date" datetime={post.data.date}>
                {new Date(post.data.date).toLocaleDateString("es-ES", {
                  month: "short",
                  day: "numeric",
                  year: "numeric",
                })}
              </time>
            </li>
          ))}
        </ul>
      </section>
    )
  }

  {
    categories.length > 0 && (
      <section class="categories">
        <h2 class="section-title" id="sidebar-category">
          <span hidden>Enlaces a entradas por </span>
          Categorias
        </h2>
        <ul class="category-list" aria-labelledby="sidebar-category">
          {categories.map((category) => (
            <li class="category-item">
              <Button
                tag="a"
                variant="secondary"
                size="sm"
                href={`${base}categorias/${category.toLowerCase().replace(/[\/\s]+/g, "-")}`}
              >
                {category}
              </Button>
            </li>
          ))}
        </ul>
      </section>
    )
  }
</div>

<style lang="scss">
  //TODO: revisar posible conflicto de sticky top por posible contenido no visible según resolución o contenidos
  .sidebar-content {
    display: flex;
    flex-direction: column;
    gap: calc(var(--grid-unit) * 4);
    padding: calc(var(--grid-unit) * 3);
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    top: 118px;
    @media (min-width: 1024px) {
      position: sticky;
    }
  }

  .section-title {
    font-family: var(--font-family-primary);
    font-size: var(--fs-paragraph-1);
    font-weight: 700;
    color: var(--color-accent);
    margin-block-end: calc(var(--grid-unit) * 1.5);
    text-transform: uppercase;
    letter-spacing: 0.03em;
    border-bottom: var(--border-width-md) solid var(--color-accent);
    padding-bottom: calc(var(--grid-unit) / 2);
  }

  .post-list {
    list-style-type: "";
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: calc(var(--grid-unit) * 1.5);
  }

  .category-list {
    list-style-type: "";
    margin: 0;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: calc(var(--grid-unit) / 2);
  }

  .post-item {
    display: flex;
    flex-direction: column;
    gap: calc(var(--grid-unit) / 2);
  }

  .post-link {
    font-weight: 400;
    line-height: 1.3;
    color: var(--color-text-primary);
    &:hover,
    &:focus {
      color: var(--color-interaction-default);
    }
  }

  .post-date {
    font-size: var(--fs-paragraph-5);
    color: var(--color-text-muted);
    font-family: var(--font-mono);
  }

  .category-item {
    display: inline-block;
  }
</style>
