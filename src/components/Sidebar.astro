---
// TODO: evitar mostrar enlace del SinglePost actual 
import Button from "@components/Button.astro";

import { getCollection } from "astro:content";

const base = import.meta.env.BASE_URL;

export interface Props {
  limitRecentPost?: number;
}

const {
  limitRecentPost = 5,
} = Astro.props;

const posts = await getCollection("blog");
const recentPosts = posts
  .sort(
    (a: any, b: any) =>
      new Date(b.data.date).getTime() -
      new Date(a.data.date).getTime(),
  )
  .slice(0, limitRecentPost);

const categories = [
  ...new Set(
    posts.flatMap((post: any) => post.data.categories || []),
  ),
];
---

<div class="skip-to-content">
  <a href="#footer">Saltar los enlaces de sidebar</a>
</div>
<div class="sidebar-content">
  {
    recentPosts.length > 0 && (
      <section class="recent-posts">
        <h2 class="section-title" id="sidebar-recent">Entradas recientes</h2>
        <ul class="post-list" aria-labelledby="sidebar-recent">
          {recentPosts.map((post: any) => (
            <li class="post-item">
              <a
                href={`${base}blog/${post.data.slug}`}
                class="post-link"
              >
                {post.data.title}
              </a>
              <time class="post-date" datetime={post.data.date}>
                {new Date(post.data.date).toLocaleDateString("es-ES", {
                  month: "short",
                  day: "numeric",
                  year: "numeric",
                })}
              </time>
            </li>
          ))}
        </ul>
      </section>
    )
  }

  {
    categories.length > 0 && (
      <section class="categories">
        <h2 class="section-title" id="sidebar-category">
          <span hidden>Enlaces a entradas por </span>
          Categorias
        </h2>
        <ul class="category-list" aria-labelledby="sidebar-category">
          {categories.map((category) => (
            <li class="category-item">
              <Button
                tag="a"
                variant="secondary"
                size="sm"
                href={`${base}categorias/${category.toLowerCase().replace(/[\/\s]+/g, "-")}`}
              >
                {category}
              </Button>
            </li>
          ))}
        </ul>
      </section>
    )
  }
</div>

<style lang="scss">
  //TODO: revisar posible conflicto de sticky top por posible contenido no visible según resolución o contenidos
  .sidebar-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    padding: var(--space-md);
    background-color: var(--color-theme-background-surface);
    border: var(--border-width-sm) solid var(--color-theme-border-default);
    border-radius: var(--border-radius-md);
    top: 86px;
    @media (min-width: 1024px) {
      position: sticky;
    }
  }

  .section-title {
    font-family: var(--typography-font-family-primary);
    font-size: var(--typography-font-size-paragraph-1);
    font-weight: var(--typography-font-weight-bold);
    color: var(--color-brand-primary);
    margin-block-end: var(--space-xs);
    text-transform: uppercase;
    letter-spacing: var(--typography-letter-spacing-md);
    border-bottom: var(--border-width-md) solid var(--color-brand-primary);
    padding-bottom: var(--space-xxxs);
  }

  .post-list {
    list-style-type: "";
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .category-list {
    list-style-type: "";
    margin: 0;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xxxs);
  }

  .post-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-xxxs);
  }

  .post-link {
    font-weight: var(--typography-font-weight-normal);
    line-height: var(--typography-line-height-md);
    color: var(--color-theme-text-primary);
    &:hover,
    &:focus {
      color: var(--color-brand-interactive);
    }
  }

  .post-date {
    font-size: var(--typography-font-size-paragraph-5);
    color: var(--color-theme-text-muted);
    font-family: var(--typography-font-family-mono);
  }

  .category-item {
    display: inline-block;
  }
</style>
