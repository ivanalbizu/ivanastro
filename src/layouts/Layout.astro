---
import "../styles/global.scss";

import Header from "@components/Header.astro";
import Sidebar from "@components/Sidebar.astro";
import Footer from "@components/Footer.astro";
import SEO from "@components/SEO.astro";
import Breadcrumbs from "@components/Breadcrumbs.astro";
const currentPath = Astro.url.pathname;

import { ClientRouter } from "astro:transitions";

export interface Props {
  title: string;
  description?: string;
  showSidebar?: boolean;
  image?: string;
  type?: "website" | "article";
  publishedTime?: string;
  canonical?: string;
}

const {
  title,
  description,
  showSidebar = true,
  image,
  type,
  publishedTime,
  canonical,
} = Astro.props;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="preload" href="/fonts/Atkinson_Hyperlegible/AtkinsonHyperlegible-Regular.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/Atkinson_Hyperlegible/AtkinsonHyperlegible-Bold.woff2" as="font" type="font/woff2" crossorigin />
    <style is:inline>
      @font-face {
        font-family: "AtkinsonHyperlegible";
        src: url("/fonts/Atkinson_Hyperlegible/AtkinsonHyperlegible-Regular.woff2")
          format("woff2");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: "AtkinsonHyperlegible";
        src: url("/fonts/Atkinson_Hyperlegible/AtkinsonHyperlegible-Bold.woff2")
          format("woff2");
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
    </style>
    <slot name="head" />
    <SEO
      title={title}
      description={description}
      image={image}
      type={type}
      publishedTime={publishedTime}
      canonical={canonical}
    />
    <ClientRouter />

    <!-- Theme Toggle Script - Versión optimizada con tipos -->
    <script>
      // @ts-nocheck - Deshabilitar verificación de tipos en este script inline
      import { TokenStyleManager } from '../assets/js/token-system.js';
      import '../assets/js/theme-toggle.js';

      let styleManager: any = null;

      function initTokenManager(): void {
        if (!styleManager) {
          styleManager = new TokenStyleManager();
        } else {
          styleManager.refresh();
        }
      }

      // Aplicar en carga inicial (antes de que se renderice la página)
      if (document.readyState === 'loading') {
        // Si el DOM aún está cargando, esperar a DOMContentLoaded
        document.addEventListener('DOMContentLoaded', initTokenManager);
      } else {
        // Si el DOM ya está listo, aplicar inmediatamente
        initTokenManager();
      }

      // View Transitions - Aplicar después de cada transición
      document.addEventListener('astro:after-swap', () => {
        initTokenManager();
      });

      // Page Load - Primera carga con View Transitions habilitadas
      document.addEventListener('astro:page-load', () => {
        initTokenManager();
      });

      // Exponer el manager globalmente para debugging
      window.__tokenManager = () => styleManager;
    </script>
  </head>
  <body>
    <Header />    
    <main
      class="main-content"
      class:list={{ "with-sidebar": showSidebar }}
      id="main-content"
    >
      <div class="content">
        <Breadcrumbs currentPath={currentPath} title={title} />
        <slot />
      </div>
      {
        showSidebar && (
          <aside class="sidebar" aria-label="Enlaces del blog">
            <Sidebar limitRecentPost={4} />
          </aside>
        )
      }
    </main>
    <Footer />
  </body>
</html>

<style lang="scss">
  .main-content {
    flex: 1;
    width: min(var(--max-width-default), 100%);
    margin-inline: auto;
    padding: var(--space-md) var(--space-semantic-padding);
  }

  .main-content.with-sidebar {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-lg);
  }

  .content {
    min-width: 0;
  }

  @media (min-width: 1024px) {
    .main-content.with-sidebar {
      grid-template-columns: 1fr var(--max-width-narrow);
    }
  }
</style>
